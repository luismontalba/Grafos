<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Gestión con grafos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
  
  <style>
    #fileContainer {
      display: block;
      background: white;
      border: 1px solid black;
      padding: 10px;
      position: absolute;
      bottom: 0;
      right: 0;
    }
    #detailContainer {
      display: none;
      background: white;
      border: 1px solid black;
      padding: 10px;
      padding-bottom: 20px;
      margin-bottom: 50px;
      position: absolute;
      bottom: 0;
      left: 0;
    }    
    #descriptionInput {
      width: 100%;
      height: 150px;
    }
    #saveButton {
      display: none;
    }
    #clearButton {
      display: none;
    }
  </style>
</head>

<!-- <body onload="sortNodesByDate();loadFromLocalStorage();fixCanvas();" onbeforeunload="sortNodesByDate();saveToLocalStorage();"> -->
<body onload="loadFromLocalStorage();sortNodesByDate();fixCanvas();" onbeforeunload="saveToLocalStorage();">

<div id="mynetwork"></div>
<div id="detailContainer">
  <input type="text" id="labelInput">
  <input type="date" id="dateInput">
  <textarea id="descriptionInput"></textarea>
  <button id="saveDetailButton">Guardar detalles</button>
</div>
<div id="fileContainer">
  <button id="saveButton">Guardar en Local Storage</button>
  <button id="clearButton">Vaciar Local Storage</button>
  <button id="exportButton">Exportar</button>
  <input type="file" id="importButton" accept=".json">
</div>

<script type="text/javascript">

  // Función para obtener la fecha de hoy en formato yyyy-MM-dd
  function getTodayDate() {
    var today = new Date();
    var yyyy = today.getFullYear();
    var MM = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    var dd = String(today.getDate()).padStart(2, '0');
    return yyyy + '-' + MM +'-' + dd;
  }

  // Función para obtener la fecha de hoy en formato yyyy-MM-dd--hh-mm-ss
  function getTodayLongDate() {
    var today = new Date();
    var hh = String(today.getHours()).padStart(2, '0');
    var mm = String(today.getMinutes()).padStart(2, '0');
    var ss = String(today.getSeconds()).padStart(2, '0');
    return getTodayDate() + '--' + hh + '-' + mm + '-' + ss;
  }

  // Crear un array con nodos
  var nodes = new vis.DataSet([
    {id: 1, label: 'Node 1\n2025-01-01', date: '2025-01-01', description: 'Descripción del Nodo 1'},
    {id: 2, label: 'Node 2\n2025-02-01', date: '2025-02-01', description: 'Descripción del Nodo 2'},
    {id: 3, label: 'Node 3\n2025-03-01', date: '2025-03-01', description: 'Descripción del Nodo 3'},
    {id: 4, label: 'Node 4\n2025-04-01', date: '2025-04-01', description: 'Descripción del Nodo 4'},
    {id: 5, label: 'Node 5\n2025-05-01', date: '2025-05-01', description: 'Descripción del Nodo 5'}
  ]);

  // Crear un array con aristas
  var edges = new vis.DataSet([
    {from: 1, to: 3, arrows: 'to'},
    {from: 1, to: 2, arrows: 'to'},
    {from: 2, to: 4, arrows: 'to'},
    {from: 2, to: 5, arrows: 'to'}
  ]);

  // Crear una red
  var container = document.getElementById('mynetwork');
  var data = {
    nodes: nodes,
    edges: edges
  };
  var options = {
    autoResize: true,
    interaction: {
      hover: true,
      multiselect: true,
      dragView: true
    },
    manipulation: {
      enabled: true,
      addNode: function (data, callback) {
        data.label = 'Nuevo Nodo\n' + getTodayDate();
        data.date = getTodayDate();
        data.description = '';
        callback(data);
        sortNodesByDate();
        saveToLocalStorage();
      },
      addEdge: function (data, callback) {
        if (data.from != data.to) {
          data.arrows = 'to';
          callback(data);
          sortNodesByDate();
          alertEdges();
          saveToLocalStorage();
        }
      }
    },
    physics: {
      enabled: false,
      solver: 'forceAtlas2Based',
      forceAtlas2Based: {
        gravitationalConstant: -50,
        centralGravity: 0.01,
        springLength: 100,
        springConstant: 0.08,
      },
      minVelocity: 3,
      timestep: 0.35
    },
    edges: {
      smooth: {
        type: 'continuous',
        forceDirection: 'none',
        roundness: 0.5
      }
    },
    layout: {
      randomSeed: 3
    }
  };
  var network = new vis.Network(container, data, options);

  // Función para ordenar nodos por fecha
  function sortNodesByDate() {
    var allNodes = nodes.get();
    allNodes.sort((a, b) => new Date(a.date) - new Date(b.date));
    var xPosition = -allNodes.length * 50;
    allNodes.forEach(node => {
      nodes.update({id: node.id, x: xPosition});
      xPosition += 100;
    });
  }

    // Evento para actualizar la posición de los nodos cuando se muevan
    network.on("dragEnd", function (params) {
    params.nodes.forEach(function (nodeId) {
      var position = network.getPositions([nodeId])[nodeId];
      nodes.update({id: nodeId, x: position.x, y: position.y});
    });
    sortNodesByDate();
    saveToLocalStorage();
  });

  // Funcion para destacar en rojo flujos imposibles
  function alertEdges() {
    var allEdges = edges.get();
    var allNodes = nodes.get();
    allEdges.forEach(edge => {
      var from = edge.from;
      var to = edge.to;
      var nodeFrom = allNodes.filter(node => node.id === from)[0];
      var nodeTo = allNodes.filter(node => node.id === to)[0];
      var dateFrom = nodeFrom.date;
      var dateTo = nodeTo.date;
      if (dateFrom > dateTo) {
        edges.update({id: edge.id, color: { color: "red" }});
      } else {
        edges.update({id: edge.id, color: { color: "blue" }});
      }
    });
  }

  // Variables para manejar el diálogo de edición
  var selectedNodeId = null;
  var detailContainer = document.getElementById('detailContainer');
  var labelInput = document.getElementById('labelInput');
  var dateInput = document.getElementById('dateInput');
  var descriptionInput = document.getElementById('descriptionInput');
  var saveDetailButton = document.getElementById('saveDetailButton');

  // Evento para editar detalle al hacer clic
  network.on("click", function (params) {
    if (params.nodes.length === 1) {
      selectedNodeId = params.nodes[0];
      var node = nodes.get(selectedNodeId);
      // Mostrar detalle
      detailContainer.style.display = 'block';
      labelInput.value = node.label.split('\n')[0];
      dateInput.value = node.date;
      descriptionInput.value = node.description;
    }
  });

  // Evento para guardar detalle
  saveDetailButton.addEventListener('click', function() {
    if (selectedNodeId != null) {
      var newLabel = labelInput.value;
      var newDate = dateInput.value;
      var newDescription = descriptionInput.value;
      nodes.update({
        id: selectedNodeId,
        label: `${newLabel}\n${newDate}`,
        date: newDate,
        description: newDescription
      });
    }
    detailContainer.style.display = 'none';
    sortNodesByDate();
    alertEdges();
    saveToLocalStorage();
  });

  // Guardar datos en Local Storage
  function saveToLocalStorage() {
    var graphData = {
      nodes: nodes.get(),
      edges: edges.get()
    };
    localStorage.setItem('graphData', JSON.stringify(graphData));
  }
  document.getElementById('saveButton').addEventListener('click', saveToLocalStorage);

  // Limpiar Local Storage
  function clearLocalStorage() {
    localStorage.clear();
  }
  document.getElementById('clearButton').addEventListener('click', clearLocalStorage);

  // Cargar datos desde Local Storage
  function loadFromLocalStorage() {
    var storedData = localStorage.getItem('graphData');
    if (storedData) {
      var graphData = JSON.parse(storedData);
      nodes.clear();
      nodes.add(graphData.nodes);
      edges.clear();
      edges.add(graphData.edges);
    }
  }

  // Exportar datos a JSON
  document.getElementById('exportButton').addEventListener('click', function() {
    var graphData = {
      nodes: nodes.get().map(node => {
        let position = network.getPositions([node.id])[node.id];
        return {...node, x: position.x, y: position.y};
      }),
      edges: edges.get()
    };
    var blob = new Blob([JSON.stringify(graphData)], {type: 'application/json'});
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'graphData'+'_'+ getTodayLongDate()+ '.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // Importar datos desde JSON
  document.getElementById('importButton').addEventListener('change', function(event) {
    var file = event.target.files[0];
    var reader = new FileReader();
    reader.onload = function(event) {
      var graphData = JSON.parse(event.target.result);
      nodes.clear();
      nodes.add(graphData.nodes);
      edges.clear();
      edges.add(graphData.edges);
      sortNodesByDate();
      alertEdges();
      saveToLocalStorage();
    };
    reader.readAsText(file);
  });

  // Corregir tamaño y escala de gráfico
  function fixCanvas() {
    var canvas = document.getElementsByTagName('canvas')[0];
    canvas.setAttribute('height', '10000');
    var ctx = canvas.getContext("2d");
    ctx.scale(2,2);
  }

</script>

</body>
</html>
